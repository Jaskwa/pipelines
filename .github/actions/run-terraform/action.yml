name: "Run Terraform"
description: "Setup Terraform for pipeline use, tf init, tf apply"
inputs:
  region:
    description: "The region to deploy into"
    required: true
  tooling-account:
    description: "The id of the tooling account"
    required: true
  project:
    description: "The name of the project."
    required: true
  account:
    description: "The name of the account."
    required: true
  state-key:
    description: "The key against which Terraform state will be stored."
    required: true
  dir:
    description: "The directory which contains the Terraform module for creating deployment roles."
    required: false
    default: deployment-roles/
runs:
  using: "composite"
  steps:
    - name: Setup-Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: 1.9.3
    - name: Create-Backend-Config
      working-directory: ${{ inputs.dir }}
      run: |
        echo 'bucket="state.terraform.${{ inputs.account }}.${{ inputs.project }}"' >> ./config.s3.tfbackend
        echo 'dynamodb_table="lock.state.terraform.${{ inputs.account }}.${{ inputs.project }}"' >> ./config.s3.tfbackend
        echo 'key="${{ inputs.state-key }}"' >> ./config.s3.tfbackend
      shell: bash
    - name: Create-Context-Config
      working-directory: ${{ inputs.dir }}
      run: |
        echo 'region="${{ inputs.region }}"' >> ./context.auto.tfvars
        echo 'account="${{ inputs.account }}"' >> ./context.auto.tfvars
        echo 'project=${{ inputs.project }}"' >> ./context.auto.tfvars
        echo 'tooling-account="${{ inputs.tooling-account }}"' >> context.auto.tfvars
      shell: bash
    - name: Terraform-Init
      working-directory: ${{ inputs.dir }}
      run: |
        terraform init -input=false -backend-config=./config.s3.tfbackend
      shell: bash
    - name: Terraform-Apply
      working-directory: ${{ inputs.dir }}
      run: |
        terraform apply -input=false -auto-approve
      shell: bash
